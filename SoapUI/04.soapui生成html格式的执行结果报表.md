import groovy.xml.MarkupBuilder

def testSuites = project.getTestSuiteList()
def projectName = project.getName()
def logPath = project.getPropertyValue('htmlReportPath').replace('\\','\\\\')

def suiteName
def fileNameList = []
def suiteNameList = []
testSuites.each{testSuite ->
	suiteName = testSuite.getName().replace('.','')
	suiteNameList.add(suiteName)
	fileNameList.add(logPath+'\\TEST-'+suiteName+'.xml')
}

HTMLWriter htmlWrite = new HTMLWriter()
htmlWrite.htmlReport(projectName,suiteNameList,fileNameList,logPath)
class HTMLWriter {
   
    public static htmlReport(def project,def suiteNameList,def fileNameList,def logPath){
    	 
      def strHTML = new StringWriter()
     // IndentPrinter indentPrinter = new IndentPrinter()
      def html = new MarkupBuilder(strHTML)
      def testCases,testSuiteName,fileName
        html.html{  
            head{  
                title("soapUI Test Results: All TestCases")  
            }  
           body{  
    			h1("soapUI Test Results")  
    			h2("All TestCases")
   			table(width:"95%", cellspacing:"2", cellpadding:"5", border:"1", class:"details"){  
      		     tr(valign:"top"){  
        			    th("Class")  
       			    th("Name")
       			    th("Status")  
       			    th("Type")  
       			    th("Time (s)")  
      		     }  
      		     for(i in 0..fileNameList.size()-1){
      		     	testSuiteName = suiteNameList[i]
      		     	fileName = fileNameList[i]
      		     	File file = new File(fileName)
      		     	if(file.exists()){
      		     		testCases = new XmlParser().parse(fileName)
      		         		testCases.testcase.each{ 
      		      		def name = it.@name
      		      		def time = it.@time
      		      		def status
      		      		if( it.text() .equals("")){
      		      			status = 'Success'
      		      		}else{
      		      			status = 'Failure'
      		      		}
      		      		 tr{       
      		      	 	 	 td(testSuiteName);
      		      	 	  	 td{a(name:name);a(href:project+"/"+project+"."+testSuiteName+".html#"+name,name) };
      		      	 	 	 td( status);
      		      	 	 	 td();
      		      	 	 	 td(time)
      		             }  
      		      }
      		   }     	
      		}  	        
    		 }  
  	  }  
    }  
        def htmlFile = logPath+"\\all-tests.html"
        PrintWriter pw = new PrintWriter(htmlFile)
        pw.write(strHTML.toString().replace('  ',''))
        pw.close()

    }
}
